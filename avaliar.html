<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <!-- Font Awesome Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        #avaliacao {
            width: 50%;
        }
        input[type=text],
        select {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type=submit] {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type=button] {
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type=submit]:hover {
            background-color: #45a049;
        }

        div {
            border-radius: 5px;
            background-color: #f2f2f2;
            padding: 20px;
        }

        .fa-star {
            font-family: FontAwesome;
            font-style: normal;
            font-weight: normal;
            color: lightgray;
            font-size: 24px;
        }

        .checked {
            color: gold;
        }

        .half-checked {
            color: rgba(255, 217, 0, 0.363);
        }
    </style>
</head>

<body>


    <div id="avaliacao">
        <form action="/action_page.php">
            <h3 id="nomeLivro"></h3>
            <img src="" id="coverLivro" />
            <br>

            <div id="estrelas">
                <span class="star" data-index="1"><i class="fa-regular fa-star"></i></span>
                <span class="star" data-index="2"><i class="fa-regular fa-star"></i></span>
                <span class="star" data-index="3"><i class="fa-regular fa-star"></i></span>
                <span class="star" data-index="4"><i class="fa-regular fa-star"></i></span>
                <span class="star" data-index="5"><i class="fa-regular fa-star"></i></span>
            </div>
            <input type="range" min="0" max="5" value="0" step="0.5" id="qtdEstrelas">

            <p><label for="w3review">Comentários sobre o livro</label></p>
            <textarea id="w3review" name="w3review" rows="4" cols="50"></textarea>
            <br>
            <input type="button" value="Gostei" />
            <input type="submit" value="Avaliar">
        </form>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rangeInput = document.getElementById("qtdEstrelas");
            const estrelas = document.querySelectorAll("#estrelas .fa-star");

            rangeInput.addEventListener("input", function () {
                const valor = parseFloat(rangeInput.value);

                estrelas.forEach((estrela, index) => {
                    estrela.classList.remove("checked", "half-checked");

                    const pos = index + 1;

                    if (valor >= pos) {
                        estrela.classList.add("checked");
                    } else if (valor >= pos - 0.5) {
                        estrela.classList.add("half-checked");
                    }
                });
            });
        });
        class OpenLibraryAPI {
            constructor() {
                this.baseURL = "https://openlibrary.org";
                this.indexQueue = [];
            }

            getWorkURL(workId) {
                return `${this.baseURL}${workId}.json`;
            }

            getBookCoverURL(coverId) {
                return `https://covers.openlibrary.org/b/id/${coverId}-M.jpg`;
            }

            async getWork(id) {
                try {
                    const response = await fetch(this.getWorkURL(id));
                    if (!response.ok) {
                        throw new Error("Erro na requisição getWork");
                    }

                    const data = await response.json();
                    const title = data.title;
                    let firstSubject = "nao-definido";

                    if (Array.isArray(data.subjects) && data.subjects.length > 0) {
                        firstSubject = data.subjects[0];
                    }

                    return { title, subject: firstSubject };
                } catch (error) {
                    throw new Error("Erro ao buscar ou processar getWork: " + error.message);
                }
            }

            async getRandomBook() {
                const url = `${this.baseURL}/people/mekBot/books/want-to-read.json?limit=20`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error("Erro na requisição fetchLivro");
                    }

                    const data = await response.json();
                    const entries = data.reading_log_entries;

                    if (!entries || entries.length === 0) {
                        throw new Error("Nenhuma entrada encontrada.");
                    }

                    // Embaralha os índices se a fila estiver vazia
                    if (this.indexQueue.length === 0) {
                        const indices = Array.from({ length: entries.length }, (_, i) => i);
                        this.shuffle(indices);
                        this.indexQueue.push(...indices);
                    }

                    const index = this.indexQueue.shift();
                    const work = entries[index].work;

                    const livro = {
                        id: work.key,
                        capaId: work.cover_id || "",
                        autor: (work.author_names && work.author_names[0]) || "Autor desconhecido",
                        dataPub: work.first_publish_year || "indefinido",
                        coverURL: ""
                    };

                    livro.coverURL = this.getBookCoverURL(livro.capaId);

                    // Busca nome e gênero com getWork
                    try {
                        const workData = await this.getWork(work.key);
                        livro.nome = workData.title;
                        livro.genero = workData.subject;
                    } catch (error) {
                        // Continua mesmo com erro
                        livro.nome = "Título desconhecido";
                        livro.genero = "Gênero indefinido";
                    }

                    return livro;

                } catch (error) {
                    throw new Error("Erro ao buscar livro aleatório: " + error.message);
                }
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
        }
        const api = new OpenLibraryAPI();

        api.getRandomBook()
            .then(livro => {
                document.getElementById("coverLivro").src = livro.coverURL;
                document.getElementById("nomeLivro").innerText = livro.nome;
                console.log("Livro aleatório:", livro);
            })
            .catch(error => {
                console.error("Erro:", error.message);
            });
    </script>
</body>

</html>